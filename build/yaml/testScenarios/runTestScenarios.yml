#
# Executes the test scenarios.
#

# "name" here defines the build number format. Build number is accessed via $(Build.BuildNumber)
name: $(BUILD.BUILDID)
trigger: none
pr: none

resources:
  pipelines:
    - pipeline: "02ADeploySkillBots"
      source: "02.A. Deploy skill bots (daily)"
      trigger:
        branches:
          include:
            - main
            - releases/*

variables:
  BuildConfiguration: "Debug"
  BuildPlatform: "Any CPU"

  ## Azure Resources (Define these variables in Azure)
  # AzureSubscription: Service Connection Name to Manage Azure resources.
  # ResourceGroup: (optional) Name of the Resource Group where the bots are deployed.
  # ResourceSuffix: (optional) Alphanumeric suffix to add to the resources' name to avoid collisions.
  # SharedResourceGroup: (optional) Name of the Shared Resource Group.

  ## Bots Configuration (Define these variables in Azure)
  # BffnComposerSkillBotDotNetAppId: (optional) App Id for BffnComposerSkillBotDotNet bot.
  # BffnEchoSkillBotComposerDotNetAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotDotNetAppId: (optional) App Id for BffnEchoSkillBotDotNet bot.
  # BffnEchoSkillBotDotNetV3AppId: (optional) App Id for BffnEchoSkillBotDotNetV3 bot.
  # BffnEchoSkillBotJSAppId: (optional) App Id for BffnEchoSkillBotJS bot.
  # BffnEchoSkillBotJSV3AppId: (optional) App Id for BffnEchoSkillBotJSV3 bot.
  # BffnEchoSkillBotPythonAppId: (optional) App Id for BffnEchoSkillBotPython bot.
  # BffnWaterfallSkillBotDotNetAppId: (optional) App Id for BffnWaterfallSkillBotDotNet bot.
  # BffnWaterfallSkillBotJSAppId: (optional) App Id for BffnWaterfallSkillBotJS bot.
  # BffnWaterfallSkillBotPythonAppId: (optional) App Id for BffnWaterfallSkillBotPython bot.
  # DeployBotResourcesGuid: (optional) Deploy Bot Resources pipeline GUID.

  ## Internal variables
  InternalCosmosDbName: "bffnbotstatedb$(INTERNALRESOURCESUFFIX)"
  InternalKeyVaultName: "bffnbotkeyvault$(INTERNALRESOURCESUFFIX)"
  InternalResourceGroupName: $[coalesce(variables['RESOURCEGROUP'], 'BFFN')]
  InternalResourceSuffix: $[coalesce(variables['RESOURCESUFFIX'], '')]
  InternalSharedResourceGroupName: $[coalesce(variables['SHAREDRESOURCEGROUP'], 'BFFN-Shared')]

pool:
  vmImage: "windows-2019"

stages:
  - template: integration.yml
    parameters:
      azureSubscription: "$(AZURESUBSCRIPTION)"
      cosmosDb: "$(INTERNALCOSMOSDBNAME)"
      resourceGroup: "$(INTERNALSHAREDRESOURCEGROUPNAME)"

  - template: functional.yml
    parameters:
      appIds:
        ComposerSkillBotDotNet: "$(BFFNCOMPOSERSKILLBOTDOTNETAPPID)"
        EchoSkillBotComposerDotNet: "$(BFFNECHOSKILLBOTCOMPOSERDOTNETAPPID)"
        EchoSkillBotDotNet: "$(BFFNECHOSKILLBOTDOTNETAPPID)"
        EchoSkillBotDotNetV3: "$(BFFNECHOSKILLBOTDOTNETV3APPID)"
        EchoSkillBotJS: "$(BFFNECHOSKILLBOTJSAPPID)"
        EchoSkillBotJSV3: "$(BFFNECHOSKILLBOTJSV3APPID)"
        EchoSkillBotPython: "$(BFFNECHOSKILLBOTPYTHONAPPID)"
        WaterfallSkillBotDotNet: "$(BFFNWATERFALLSKILLBOTDOTNETAPPID)"
        WaterfallSkillBotJS: "$(BFFNWATERFALLSKILLBOTJSAPPID)"
        WaterfallSkillBotPython: "$(BFFNWATERFALLSKILLBOTPYTHONAPPID)"
      azureSubscription: "$(AZURESUBSCRIPTION)"
      deployBuildId: "$(resources.pipeline.02ADeploySkillBots.runID)"
      keyVault: "$(INTERNALKEYVAULTNAME)"
      resourceGroup: "$(INTERNALRESOURCEGROUPNAME)"
      resourceSuffix: "$(INTERNALRESOURCESUFFIX)"

  # - stage: "Build_DotNet_Integration"
  #   displayName: "Build DotNet Integration"
  #   dependsOn: []
  #   jobs:
  #     - job: "Build"
  #       displayName: "Build IntegrationTests.csproj"
  #       steps:
  #         - template: build.yml
  #           parameters:
  #             project: "Tests/Integration/DotNet/IntegrationTests.csproj"
  #             destZip: "Integration/DotNet.zip"

  # - stage: "Test_DotNet_Integration"
  #   displayName: "Test DotNet Integration"
  #   dependsOn: Build_DotNet_Integration
  #   jobs:
  #     - job: "Test_Azure_CosmosDb"
  #       displayName: "Test Azure.CosmosDb"
  #       steps:
  #         - checkout: none
  #         - template: ../common/getCosmosDbConnectionVariables.yml
  #           parameters:
  #             azureSubscription: "$(AZURESUBSCRIPTION)"
  #             resourceName: "$(INTERNALCOSMOSDBNAME)"
  #             resourceGroup: "$(INTERNALSHAREDRESOURCEGROUPNAME)"
  #         - template: test.yml
  #           parameters:
  #             zip: "Integration/DotNet.zip"
  #             dll: "IntegrationTests.dll"
  #             namespace: "IntegrationTests.Azure.CosmosDb"
  #             trx: "Integration-DotNet-$(BUILD.BUILDNUMBER).trx"
  #             env:
  #               Azure:CosmosDb:ServiceEndpoint: "$(COSMOSDBSERVICEENDPOINT)"
  #               Azure:CosmosDb:AuthKey: "$(COSMOSDBAUTHKEY)"

  # Functional Tests

  # - stage: "Build_Functional"
  #   displayName: "Build Functional"
  #   dependsOn: []
  #   jobs:
  #     - job: "Build"
  #       displayName: "Build FunctionalTests.csproj"
  #       steps:
  #         - template: build.yml
  #           parameters:
  #             project: "Tests/Functional/FunctionalTests.csproj"
  #             destZip: "Functional/Functional.zip"

  # - stage: "Configure_Functional"
  #   displayName: "Configure Functional"
  #   dependsOn: Build_Functional
  #   variables:
  #     DeployBuildId: "$(resources.pipeline.02ADeploySkillBots.runID)"
  #   jobs:
  #     - job: "Configure"
  #       displayName: "Configure Consumers"
  #       steps:
  #         - template: configureConsumers.yml
  #           parameters:
  #             appIds:
  #               ComposerSkillBotDotNet: "$(BFFNCOMPOSERSKILLBOTDOTNETAPPID)"
  #               EchoSkillBotComposerDotNet: "$(BFFNECHOSKILLBOTCOMPOSERDOTNETAPPID)"
  #               EchoSkillBotDotNet: "$(BFFNECHOSKILLBOTDOTNETAPPID)"
  #               EchoSkillBotDotNetV3: "$(BFFNECHOSKILLBOTDOTNETV3APPID)"
  #               EchoSkillBotJS: "$(BFFNECHOSKILLBOTJSAPPID)"
  #               EchoSkillBotJSV3: "$(BFFNECHOSKILLBOTJSV3APPID)"
  #               EchoSkillBotPython: "$(BFFNECHOSKILLBOTPYTHONAPPID)"
  #               WaterfallSkillBotDotNet: "$(BFFNWATERFALLSKILLBOTDOTNETAPPID)"
  #               WaterfallSkillBotJS: "$(BFFNWATERFALLSKILLBOTJSAPPID)"
  #               WaterfallSkillBotPython: "$(BFFNWATERFALLSKILLBOTPYTHONAPPID)"
  #             azureSubscription: "$(AZURESUBSCRIPTION)"
  #             keyVault: "$(INTERNALKEYVAULTNAME)"
  #             resourceGroup: "$(INTERNALRESOURCEGROUPNAME)"
  #             resourceSuffix: "$(INTERNALRESOURCESUFFIX)-$(DEPLOYBUILDID)"

  # - stage: "Test_Functional"
  #   displayName: "Test Functional"
  #   dependsOn: Configure_Functional
  #   variables:
  #     Zip: "Functional/Functional.zip"
  #     Dll: "FunctionalTests.dll"
  #     BaseNamespace: "SkillFunctionalTests.Skills"
  #     AppSettings: $[stageDependencies.Configure_Functional.Configure.outputs['Configure_Consumers.ConfigureAppSettingsContent']]
  #   jobs:
  #     - job: "Test_Skills_CardActions"
  #       displayName: "Test Skills.CardActions"
  #       steps:
  #         - checkout: none
  #         - template: test.yml
  #           parameters:
  #             zip: "$(ZIP)"
  #             dll: "$(DLL)"
  #             namespace: "$(BASENAMESPACE).CardActions"
  #             trx: "$(BASENAMESPACE).CardActions-$(BUILD.BUILDNUMBER).trx"
  #             appSettings: "$(APPSETTINGS)"
  #     - job: "Test_Skills_FileUpload"
  #       displayName: "Test Skills.FileUpload"
  #       steps:
  #         - checkout: none
  #         - template: test.yml
  #           parameters:
  #             zip: "$(ZIP)"
  #             dll: "$(DLL)"
  #             namespace: "$(BASENAMESPACE).FileUpload"
  #             trx: "$(BASENAMESPACE).FileUpload-$(BUILD.BUILDNUMBER).trx"
  #             appSettings: "$(APPSETTINGS)"
  #     - job: "Test_Skills_MessageWithAttachment"
  #       displayName: "Test Skills.MessageWithAttachment"
  #       steps:
  #         - checkout: none
  #         - template: test.yml
  #           parameters:
  #             zip: "$(ZIP)"
  #             dll: "$(DLL)"
  #             namespace: "$(BASENAMESPACE).MessageWithAttachment"
  #             trx: "$(BASENAMESPACE).MessageWithAttachment-$(BUILD.BUILDNUMBER).trx"
  #             appSettings: "$(APPSETTINGS)"
  #     - job: "Test_Skills_ProactiveMessages"
  #       displayName: "Test Skills.ProactiveMessages"
  #       steps:
  #         - checkout: none
  #         - template: test.yml
  #           parameters:
  #             zip: "$(ZIP)"
  #             dll: "$(DLL)"
  #             namespace: "$(BASENAMESPACE).ProactiveMessages"
  #             trx: "$(BASENAMESPACE).ProactiveMessages-$(BUILD.BUILDNUMBER).trx"
  #             appSettings: "$(APPSETTINGS)"
  #     - job: "Test_Skills_SignIn"
  #       displayName: "Test Skills.SignIn"
  #       steps:
  #         - checkout: none
  #         - template: test.yml
  #           parameters:
  #             zip: "$(ZIP)"
  #             dll: "$(DLL)"
  #             namespace: "$(BASENAMESPACE).SignIn"
  #             trx: "$(BASENAMESPACE).SignIn-$(BUILD.BUILDNUMBER).trx"
  #             appSettings: "$(APPSETTINGS)"
  #     - job: "Test_Skills_SingleTurn"
  #       displayName: "Test Skills.SingleTurn"
  #       steps:
  #         - checkout: none
  #         - template: test.yml
  #           parameters:
  #             zip: "$(ZIP)"
  #             dll: "$(DLL)"
  #             namespace: "$(BASENAMESPACE).SingleTurn"
  #             trx: "$(BASENAMESPACE).SingleTurn-$(BUILD.BUILDNUMBER).trx"
  #             appsettings: "$(APPSETTINGS)"
