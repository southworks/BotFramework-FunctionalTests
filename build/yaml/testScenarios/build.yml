parameters:
  - name: project
    displayName: Path to the .csproj file
    type: string

  - name: destZip
    displayName: Path where the .zip file will be saved into Artifacts
    type: string

steps:
  - task: UseDotNet@2
    displayName: "Use .NET Core SDK 3.1"
    inputs:
      version: 3.1.x

  - task: DotNetCoreCLI@2
    displayName: "Build"
    inputs:
      command: publish
      publishWebProjects: false
      projects: "${{ parameters.project }}"
      arguments: "--output $(BUILD.ARTIFACTSTAGINGDIRECTORY)/Build"
      modifyOutputPath: true

  - task: PowerShell@2
    displayName: "Prepare Publish"
    inputs:
      targetType: inline
      failOnStderr: true
      workingDirectory: "$(BUILD.ARTIFACTSTAGINGDIRECTORY)"
      script: |
        $zipName = "${{ parameters.project }}".Split("/")[-2] + ".zip";
        $destZip = "Publish/${{ parameters.destZip }}";
        $newZipName = $destZip.Split("/")[-1];
        $destFolder = $destZip.Replace($newZipName, "");

        New-Item -Path $destFolder -ItemType Directory;
        Move-Item -Path "Build/$zipName" -Destination $destZip;

  - task: PublishBuildArtifacts@1
    displayName: "Publish Build"
    inputs:
      pathToPublish: "$(BUILD.ARTIFACTSTAGINGDIRECTORY)/Publish"
      artifactName: "Build"
